#!/usr/bin/env node
/**
 * Scans content/ folder structure and generates index.generated.ts.
 * Structure: content/{project}/{document}.tsx
 * Run before dev/build (via predev/prebuild).
 */

const fs = require("fs");
const path = require("path");

const CONTENT_DIR = path.join(__dirname, "../content");
const OUTPUT_FILE = path.join(CONTENT_DIR, "index.generated.ts");

function scanContent() {
  const projects = [];
  const documents = {};

  const entries = fs.readdirSync(CONTENT_DIR, { withFileTypes: true });

  for (const entry of entries) {
    if (!entry.isDirectory()) continue;
    if (entry.name.startsWith(".")) continue;

    const projectPath = path.join(CONTENT_DIR, entry.name);
    const files = fs.readdirSync(projectPath);

    const docs = files
      .filter((f) => f.endsWith(".tsx") && f !== "index.generated.ts")
      .map((f) => f.replace(/\.tsx$/, ""));

    if (docs.length > 0) {
      projects.push(entry.name);
      documents[entry.name] = docs;
    }
  }

  return { projects, documents };
}

function generateIndex(projects, documents) {
  const loaders = [];
  for (const project of projects) {
    for (const doc of documents[project]) {
      const key = `${project}/${doc}`;
      loaders.push(`  "${key}": () => import("./${project}/${doc}"),`);
    }
  }

  return `/**
 * Auto-generated by scripts/generate-content-index.js
 * Do not edit. Run \`npm run generate-content\` to regenerate.
 */

export const projects: string[] = ${JSON.stringify(projects)};

export const documents: Record<string, string[]> = ${JSON.stringify(documents, null, 2)};

const loaders: Record<string, () => Promise<{ default: React.ComponentType }>> = {
${loaders.join("\n")}
};

export async function getDocument(project: string, document: string) {
  const key = \`\${project}/\${document}\`;
  const loader = loaders[key];
  if (!loader) return null;
  const mod = await loader();
  return mod.default;
}
`;
}

function main() {
  const { projects, documents } = scanContent();
  const output = generateIndex(projects, documents);
  fs.writeFileSync(OUTPUT_FILE, output, "utf8");
  console.log(`Generated ${OUTPUT_FILE} (${projects.length} projects)`);
}

main();
